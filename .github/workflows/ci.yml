name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  BACKEND_IMAGE: azurecostmon-backend
  FRONTEND_IMAGE: azurecostmon-frontend
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

jobs:
  # ── Stage 1: Test & Build ──────────────────────────────────────
  backend-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: azure_cost_monitor_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      - name: Run backend tests
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: azure_cost_monitor_test
          DB_USER: postgres
          DB_PASSWORD: postgres
          JWT_SECRET: test-secret
          AZURE_USE_MOCK: "true"
        run: npm test || echo "No tests configured yet"

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

  # ── Stage 2: Build & Push Docker Images to ACR ──────────────────
  docker-push:
    needs: [backend-test, frontend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "tag=$(echo $GITHUB_SHA | head -c 7)" >> $GITHUB_OUTPUT

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push backend image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }} \
                        -t ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest \
                        ./backend
          docker push ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }}
          docker push ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest

      - name: Build and push frontend image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tag }} \
                        -t ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest \
                        ./frontend
          docker push ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tag }}
          docker push ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest

  # ── Stage 3: Deploy Infrastructure (Bicep) ─────────────────────
  deploy-infra:
    needs: [docker-push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      backend-fqdn: ${{ steps.bicep.outputs.backendFqdn }}
      frontend-fqdn: ${{ steps.bicep.outputs.frontendFqdn }}

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep template
        id: bicep
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          region: eastus
          template: infra/main.bicep
          parameters: >
            infra/parameters.json
            dbAdminPassword=${{ secrets.DB_ADMIN_PASSWORD }}
            jwtSecret=${{ secrets.JWT_SECRET }}
            azureTenantId=${{ secrets.AZURE_TENANT_ID }}
            azureClientId=${{ secrets.AZURE_CLIENT_ID }}
            azureClientSecret=${{ secrets.AZURE_CLIENT_SECRET }}
            azureSubscriptionIds=${{ secrets.AZURE_SUBSCRIPTION_IDS }}

  # ── Stage 4: Update Container Apps ─────────────────────────────
  deploy-apps:
    needs: [docker-push, deploy-infra]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy backend container
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: azurecostmon-backend-prod
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ needs.docker-push.outputs.image-tag }}

      - name: Deploy frontend container
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: azurecostmon-frontend-prod
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ needs.docker-push.outputs.image-tag }}

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend image:** ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ needs.docker-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend image:** ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ needs.docker-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY

  # ── Stage 5: Seed Database (manual trigger only) ───────────────
  seed-database:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: [deploy-apps]

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run seed via Container App exec
        run: |
          az containerapp exec \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name azurecostmon-backend-prod \
            --command "node seed.js"
